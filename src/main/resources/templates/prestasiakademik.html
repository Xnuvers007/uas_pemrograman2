<!DOCTYPE html>
<html lang="en" id="htmlElement" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Prestasi Akademik</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.7/dist/sweetalert2.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        [data-bs-theme="dark"] {
            background-color: #212529;
            color: #fff;
        }
        [data-bs-theme="dark"] .container {
            background-color: #343a40;
            color: #fff;
        }
        [data-bs-theme="dark"] .table th,
        [data-bs-theme="dark"] .table td {
            border-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h1>Data Prestasi Akademik</h1>
            <p id="currentDate" class="mb-0"></p>
            <button id="themeSwitchBtn" class="btn btn-sm btn-light ms-2" onclick="toggleTheme()">Change Theme</button>
        </div>
        <form id="prestasiAkademikForm" class="mb-4">
            <div class="form-group">
                <label for="deskripsiAtauNilai">Deskripsi atau Nilai:</label>
                <input type="text" class="form-control" id="deskripsiAtauNilai" name="deskripsiAtauNilai"/>
            </div>
            <div class="form-group">
                <label for="mataPelajaran">Mata Pelajaran:</label>
                <select class="form-control" id="mataPelajaran" name="mataPelajaran"></select>
            </div>
            <div class="form-group">
                <label for="siswa">Siswa:</label>
                <select class="form-control" id="siswa" name="siswa"></select>
            </div>
            <div class="form-group">
                <label for="jenisPrestasi">Jenis Prestasi:</label>
                <input type="text" class="form-control" id="jenisPrestasi" name="jenisPrestasi"/>
            </div>
            <div class="form-group">
                <label for="tanggal">Tanggal:</label>
                <input type="date" class="form-control" id="tanggal" name="tanggal"/>
            </div>
            <br />
            <button type="button" class="btn btn-success" onclick="submitForm()">Simpan</button>
            <button type="button" class="btn btn-secondary" onclick="clearForm()">Batal</button>
            <button type="button" class="btn btn-primary" onclick="checkapi()">Check API</button>
        </form>
        <h2 class="text-center mb-4">Data Prestasi Akademik</h2>
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="thead-dark">
                    <tr>
                        <th>ID</th>
                        <th>Deskripsi atau Nilai</th>
                        <th>Mata Pelajaran</th>
                        <th>ID Mata Pelajaran</th>
                        <th>Siswa</th>
                        <th>ID Siswa</th>
                        <th>Jenis Prestasi</th>
                        <th>Tanggal</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="prestasiAkademikTableBody">
                    <!-- Data prestasi akademik akan ditampilkan di sini -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.7/dist/sweetalert2.min.js"></script>
    <script>
        function getCurrentDate() {
            var currentDate = new Date();
            var day = currentDate.getDate();
            var month = currentDate.getMonth() + 1;
            var year = currentDate.getFullYear();
            var hours = currentDate.getHours();
            var minutes = currentDate.getMinutes();
            var seconds = currentDate.getSeconds();
            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        }

        function displayCurrentDate() {
            document.getElementById('currentDate').textContent = getCurrentDate();
        }

        function toggleTheme() {
            var htmlElement = document.documentElement;
            var currentTheme = htmlElement.getAttribute('data-bs-theme');
            var newTheme = currentTheme === 'light' ? 'dark' : 'light';
            htmlElement.setAttribute('data-bs-theme', newTheme);
        }

        function checkapi() {
            Swal.fire('Success!', 'Segera Diarahkan', 'success');
            window.location.href = "/api/prestasiakademik";
        }

        // URL API
        const baseUrl = 'http://localhost:8080/api/prestasiakademik';
        const mataPelajaranUrl = 'http://localhost:8080/api/matapelajaran';
        const siswaUrl = 'http://localhost:8080/api/siswa';

        // Function untuk mengambil data dari API menggunakan XHR
        function fetchData(url, callback) {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    callback(null, data);
                } else {
                    callback('Error fetching data', null);
                }
            };
            xhr.send();
        }

        // Function untuk mengisi dropdown Mata Pelajaran
        function populateMataPelajaranDropdown() {
            fetchData(mataPelajaranUrl, (error, data) => {
                if (!error) {
                    const select = document.getElementById('mataPelajaran');
                    select.innerHTML = '';
                    data.forEach(mataPelajaran => {
                        const option = document.createElement('option');
                        option.value = mataPelajaran.id;
                        option.textContent = `${mataPelajaran.kodeMapel} - ${mataPelajaran.namaMapel}`;
                        select.appendChild(option);
                    });
                } else {
                    console.error('Error fetching Mata Pelajaran data:', error);
                }
            });
        }

        // Function untuk mengisi dropdown Siswa
        function populateSiswaDropdown() {
            fetchData(siswaUrl, (error, data) => {
                if (!error) {
                    const select = document.getElementById('siswa');
                    select.innerHTML = '';
                    data.forEach(siswa => {
                        const option = document.createElement('option');
                        option.value = siswa.id;
                        option.textContent = `${siswa.namaLengkap}`;
                        select.appendChild(option);
                    });
                } else {
                    console.error('Error fetching Siswa data:', error);
                }
            });
        }

        // Function untuk menampilkan data Prestasi Akademik di tabel
        function renderPrestasiAkademikTable() {
            fetchData(baseUrl, (error, data) => {
                if (!error) {
                    const tableBody = document.getElementById('prestasiAkademikTableBody');
                    tableBody.innerHTML = '';
                    data.forEach(prestasi => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${prestasi.id}</td>
                            <td>${prestasi.deskripsiAtauNilai}</td>
                            <td>${prestasi.mataPelajaran ? prestasi.mataPelajaran.namaMapel : '-'}</td>
                            <td>${prestasi.mataPelajaran ? prestasi.mataPelajaran.id : '-'}</td>
                            <td>${prestasi.siswa ? prestasi.siswa.namaLengkap : '-'}</td>
                            <td>${prestasi.siswa ? prestasi.siswa.id : '-'}</td>
                            <td>${prestasi.jenisPrestasi}</td>
                            <td>${prestasi.tanggal}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="editPrestasiAkademik(${prestasi.id})">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deletePrestasiAkademik(${prestasi.id})">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    Swal.fire('Success!', 'Data Prestasi Akademik ditampilkan', 'success');
                } else {
                    console.error('Error fetching Prestasi Akademik data:', error);
                }
            });
        }

        // Function untuk menghapus data Prestasi Akademik
        function deletePrestasiAkademik(id) {
            // if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                Swal.fire({
        title: 'Apakah Anda yakin?',
        text: "Data prestasi akademik ini akan dihapus secara permanen!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, hapus!',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
                const xhr = new XMLHttpRequest();
                xhr.open('DELETE', `${baseUrl}/${id}`, true);
                xhr.onload = function() {
                    if (xhr.status === 200 || xhr.status === 204) {
                        renderPrestasiAkademikTable();
                        Swal.fire('Sukses!', 'Data Prestasi Akademik berhasil dihapus!', 'success');
                    } else {
                        // console.error('Error deleting data');
                        Swal.fire('Gagal!', 'Gagal menghapus data prestasi akademik.', 'error');
                    }
                };
                xhr.send();
            }
    });
}

        // Function untuk mengedit data Prestasi Akademik
        function editPrestasiAkademik(id) {
    fetchData(`${baseUrl}/${id}`, (error, data) => {
        if (!error) {
            Swal.fire({
                title: 'Konfirmasi',
                text: `Apakah Anda ingin mengedit data prestasi akademik dengan nama ${data.siswa.namaLengkap}?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ya, edit!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('deskripsiAtauNilai').value = data.deskripsiAtauNilai;
                    document.getElementById('mataPelajaran').value = data.mataPelajaran.id;
                    document.getElementById('siswa').value = data.siswa.id;
                    document.getElementById('jenisPrestasi').value = data.jenisPrestasi;
                    document.getElementById('tanggal').value = data.tanggal;
                    // Store the ID in a hidden input field to use when updating
                    document.getElementById('prestasiAkademikForm').setAttribute('data-edit-id', id);
                }
            });
        } else {
            console.error('Error fetching data for editing:', error);
            Swal.fire('Gagal!', 'Gagal mengambil data prestasi akademik.', 'error');
        }
    });
}


        // Function untuk mengirimkan data ke server
        function submitForm() {
            const form = document.getElementById('prestasiAkademikForm');
            const deskripsiAtauNilai = form.deskripsiAtauNilai.value;
            const mataPelajaran = form.mataPelajaran.value;
            const siswa = form.siswa.value;
            const jenisPrestasi = form.jenisPrestasi.value;
            const tanggal = form.tanggal.value;

            const prestasiAkademik = {
                deskripsiAtauNilai: deskripsiAtauNilai,
                mataPelajaran: { id: parseInt(mataPelajaran) },
                siswa: { id: parseInt(siswa) },
                jenisPrestasi: jenisPrestasi,
                tanggal: tanggal
            };

            const editId = form.getAttribute('data-edit-id');
            const xhr = new XMLHttpRequest();
            xhr.open(editId ? 'PUT' : 'POST', editId ? `${baseUrl}/${editId}` : baseUrl, true);
            xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    clearForm();
                    renderPrestasiAkademikTable();
                    Swal.fire('Success!', 'Data has been saved successfully.', 'success');
                } else {
                    console.error('Error saving data');
                }
            };
            xhr.send(JSON.stringify(prestasiAkademik));
        }

        // Function untuk membersihkan form
        function clearForm() {
            const form = document.getElementById('prestasiAkademikForm');
            form.deskripsiAtauNilai.value = '';
            form.mataPelajaran.value = '';
            form.siswa.value = '';
            form.jenisPrestasi.value = '';
            form.tanggal.value = '';
            form.removeAttribute('data-edit-id');
        }

        // Inisialisasi awal
        document.addEventListener('DOMContentLoaded', function() {
            populateMataPelajaranDropdown();
            populateSiswaDropdown();
            renderPrestasiAkademikTable();
            displayCurrentDate();
            setInterval(displayCurrentDate, 1000); // Update the date every second
        });
    </script>
</body>
</html>
